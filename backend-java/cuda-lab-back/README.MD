# üé® CUDA Lab Backend - UPSGlam 2.0

## üìã Descripci√≥n General

El **CUDA Lab Backend** es el microservicio de procesamiento de im√°genes que utiliza **PyCUDA** para aplicar filtros y efectos a im√°genes mediante aceleraci√≥n por GPU NVIDIA. Implementado con **FastAPI**, este servicio proporciona endpoints RESTful de alto rendimiento para el procesamiento de im√°genes en tiempo real.

---

## üèóÔ∏è Arquitectura

### Stack Tecnol√≥gico
- **Framework**: FastAPI 0.122.0
- **GPU Computing**: PyCUDA 2025.1.2
- **Image Processing**: OpenCV 4.10.0, Pillow 12.0.0
- **Runtime**: Python 3.10+
- **CUDA**: NVIDIA CUDA Toolkit 12.x
- **Server**: Uvicorn 0.38.0 (ASGI)
- **Container**: Docker con soporte GPU

### Dependencias Principales
```python
fastapi==0.122.0
pycuda==2025.1.2
opencv-python-headless==4.10.0.84
pillow==12.0.0
numpy==2.2.1
scipy==1.14.1
uvicorn==0.38.0
```

---

## üöÄ Caracter√≠sticas Principales

### 1. **Procesamiento GPU Acelerado**
- Convoluciones CUDA optimizadas
- Kernels personalizados para cada filtro
- Procesamiento paralelo masivo
- Performance 10-50x m√°s r√°pido que CPU

### 2. **Filtros Implementados**

#### Filtros de Desenfoque (Blur)
- **Gaussian Blur**: Desenfoque gaussiano suave
- **Box Blur**: Desenfoque de caja uniforme

#### Filtros de Detecci√≥n de Bordes
- **Prewitt**: Detecci√≥n de bordes con operador Prewitt
- **Laplacian**: Detecci√≥n de bordes con Laplaciano

#### Filtros Especiales
- **UPS Logo**: Overlay del logo de la Universidad
- **Boomerang**: Efecto espejo boomerang
- **CR7**: M√°scara tem√°tica de CR7

### 3. **API Endpoints**

#### Endpoints Modernos (`/filters/*`)
- `POST /filters/apply`: Aplicar filtro por nombre
- `GET /filters/available`: Listar filtros disponibles

#### Endpoints Legacy (`/convolve`)
- `POST /convolve`: Endpoint legacy con config manual CUDA

---

## üóÇÔ∏è Estructura del Proyecto

```
cuda-lab-back/
‚îú‚îÄ‚îÄ app.py                    # FastAPI application
‚îú‚îÄ‚îÄ convolution_service.py    # CUDA convolution logic
‚îú‚îÄ‚îÄ cuda_kernels.py           # CUDA kernel definitions
‚îú‚îÄ‚îÄ image_utils.py            # Image processing utilities
‚îú‚îÄ‚îÄ progressive_convolution.py # Progressive processing
‚îú‚îÄ‚îÄ filters/                  # Filter implementations
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ gaussian.py
‚îÇ   ‚îú‚îÄ‚îÄ box_blur.py
‚îÇ   ‚îú‚îÄ‚îÄ prewitt.py
‚îÇ   ‚îú‚îÄ‚îÄ laplacian.py
‚îÇ   ‚îú‚îÄ‚îÄ ups_logo.py
‚îÇ   ‚îú‚îÄ‚îÄ boomerang.py
‚îÇ   ‚îú‚îÄ‚îÄ cr7.py
‚îÇ   ‚îî‚îÄ‚îÄ assets/              # Filter assets (logos, masks)
‚îú‚îÄ‚îÄ tests/                    # Unit tests
‚îÇ   ‚îú‚îÄ‚îÄ test_filters.py
‚îÇ   ‚îî‚îÄ‚îÄ test_cuda.py
‚îú‚îÄ‚îÄ requirements.txt
‚îú‚îÄ‚îÄ Dockerfile
‚îú‚îÄ‚îÄ docker-compose.yml
‚îî‚îÄ‚îÄ README.md
```

---

## üîß Configuraci√≥n

### Requisitos del Sistema

#### Hardware
- **GPU**: NVIDIA GPU con Compute Capability 3.5+
- **VRAM**: M√≠nimo 2GB recomendado
- **Drivers**: NVIDIA Driver 525+ para CUDA 12

#### Software
- **CUDA Toolkit**: 12.x
- **Python**: 3.10+
- **pip**: 23.0+

### Variables de Entorno

| Variable | Descripci√≥n | Default | Requerido |
|----------|-------------|---------|-----------|
| `CUDA_VISIBLE_DEVICES` | GPUs a usar | `0` | ‚ùå |
| `PORT` | Puerto del servicio | `5000` | ‚ùå |
| `HOST` | Host binding | `0.0.0.0` | ‚ùå |
| `WORKERS` | Workers de Uvicorn | `1` | ‚ùå |

### Instalaci√≥n Local

```bash
# 1. Clonar repositorio
cd backend-java/cuda-lab-back

# 2. Crear entorno virtual
python -m venv venv

# Windows
.\venv\Scripts\activate

# Linux/Mac
source venv/bin/activate

# 3. Instalar dependencias
pip install -r requirements.txt

# 4. Verificar CUDA
python -c "import pycuda.driver as cuda; cuda.init(); print(f'CUDA devices: {cuda.Device.count()}')"
```

---

## üì° API Endpoints

### Base URL
- **Local**: `http://localhost:5000`
- **Docker**: `http://cuda-backend:5000`
- **Gateway**: `http://localhost:8080/api/filters`

---

### 1. Health Check

#### `GET /health`
Verificar estado del servicio y GPU.

**Response:**
```json
{
  "status": "ok",
  "cuda_available": true,
  "gpu_count": 1,
  "gpu_name": "NVIDIA GeForce RTX 3060"
}
```

---

### 2. Filtros Modernos

#### `GET /filters/available`
Obtener lista de filtros disponibles.

**Response:**
```json
{
  "filters": [
    {
      "name": "gaussian",
      "display_name": "Gaussian Blur",
      "description": "Suaviza la imagen con desenfoque gaussiano",
      "category": "blur",
      "parameters": {
        "mask_size": [3, 5, 7, 9],
        "default_mask_size": 5
      }
    },
    {
      "name": "prewitt",
      "display_name": "Prewitt Edge Detection",
      "description": "Detecta bordes usando operador Prewitt",
      "category": "edge_detection",
      "parameters": {
        "gain": "float",
        "default_gain": 8.0
      }
    }
    // ... m√°s filtros
  ]
}
```

#### `POST /filters/apply`
Aplicar filtro a una imagen.

**Request (multipart/form-data):**
```bash
curl -X POST http://localhost:5000/filters/apply \
  -F "image=@photo.jpg" \
  -F "filter_name=gaussian" \
  -F "mask_size=5"
```

**Form Data:**
- `image`: Archivo de imagen (JPEG, PNG)
- `filter_name`: Nombre del filtro
- `mask_size` (opcional): Tama√±o del kernel (3, 5, 7, 9)
- `gain` (opcional): Ganancia para filtros de bordes

**Response:**
- Content-Type: `image/jpeg` o `image/png`
- Body: Imagen procesada

**Error Response:**
```json
{
  "detail": "Filter 'invalid_filter' not found. Available filters: gaussian, box_blur, prewitt, ..."
}
```

---

### 3. Endpoint Legacy

#### `POST /convolve`
Aplicar convoluci√≥n con configuraci√≥n CUDA manual.

**Request:**
```json
{
  "image_base64": "data:image/jpeg;base64,/9j/4AAQSkZJRg...",
  "filter": {
    "type": "blur",
    "mask_size": 5,
    "gain": 8.0
  },
  "cuda_config": {
    "block_dim": [16, 16],
    "grid_dim": [32, 32]
  }
}
```

**Response:**
```json
{
  "result_image_base64": "data:image/jpeg;base64,/9j/4AAQSkZJRg...",
  "execution_time_ms": 45.6,
  "filter_applied": "blur",
  "image_size": [1920, 1080]
}
```

---

## üé® Filtros Disponibles

### 1. Gaussian Blur (`gaussian`)

**Descripci√≥n**: Desenfoque suave usando distribuci√≥n gaussiana.

**Par√°metros**:
- `mask_size`: 3, 5, 7, 9 (default: 5)

**Uso**:
```bash
curl -X POST http://localhost:5000/filters/apply \
  -F "image=@photo.jpg" \
  -F "filter_name=gaussian" \
  -F "mask_size=5" \
  -o gaussian_output.jpg
```

**Kernel Gaussiano (5x5)**:
```
[ 1,  4,  7,  4, 1 ]
[ 4, 16, 26, 16, 4 ]
[ 7, 26, 41, 26, 7 ]
[ 4, 16, 26, 16, 4 ]
[ 1,  4,  7,  4, 1 ]
/ 273
```

---

### 2. Box Blur (`box_blur`)

**Descripci√≥n**: Desenfoque uniforme promediando p√≠xeles vecinos.

**Par√°metros**:
- `mask_size`: 3, 5, 7, 9 (default: 5)

**Uso**:
```bash
curl -X POST http://localhost:5000/filters/apply \
  -F "image=@photo.jpg" \
  -F "filter_name=box_blur" \
  -o box_blur_output.jpg
```

**Kernel Box (5x5)**:
```
[ 1, 1, 1, 1, 1 ]
[ 1, 1, 1, 1, 1 ]
[ 1, 1, 1, 1, 1 ]
[ 1, 1, 1, 1, 1 ]
[ 1, 1, 1, 1, 1 ]
/ 25
```

---

### 3. Prewitt Edge Detection (`prewitt`)

**Descripci√≥n**: Detecta bordes horizontales y verticales.

**Par√°metros**:
- `gain`: Factor de amplificaci√≥n (default: 8.0)

**Uso**:
```bash
curl -X POST http://localhost:5000/filters/apply \
  -F "image=@photo.jpg" \
  -F "filter_name=prewitt" \
  -F "gain=8.0" \
  -o prewitt_output.jpg
```

**Kernels Prewitt**:
```
Gx (horizontal):        Gy (vertical):
[-1, 0, 1]              [-1,-1,-1]
[-1, 0, 1]              [ 0, 0, 0]
[-1, 0, 1]              [ 1, 1, 1]
```

**Magnitude**: `sqrt(Gx¬≤ + Gy¬≤) * gain`

---

### 4. Laplacian Edge Detection (`laplacian`)

**Descripci√≥n**: Detecta bordes usando operador Laplaciano.

**Par√°metros**:
- `gain`: Factor de amplificaci√≥n (default: 8.0)

**Uso**:
```bash
curl -X POST http://localhost:5000/filters/apply \
  -F "image=@photo.jpg" \
  -F "filter_name=laplacian" \
  -o laplacian_output.jpg
```

**Kernel Laplaciano (3x3)**:
```
[ 0, -1,  0 ]
[-1,  4, -1 ]
[ 0, -1,  0 ]
```

---

### 5. UPS Logo (`ups_logo`)

**Descripci√≥n**: Overlay del logo de la Universidad Polit√©cnica Salesiana.

**Par√°metros**: Ninguno

**Uso**:
```bash
curl -X POST http://localhost:5000/filters/apply \
  -F "image=@photo.jpg" \
  -F "filter_name=ups_logo" \
  -o ups_logo_output.jpg
```

**Caracter√≠sticas**:
- Logo PNG con transparencia
- Posicionamiento: Esquina inferior derecha
- Tama√±o: 15% del ancho de imagen
- Alpha blending para transparencia

---

### 6. Boomerang (`boomerang`)

**Descripci√≥n**: Efecto espejo boomerang horizontal.

**Par√°metros**: Ninguno

**Uso**:
```bash
curl -X POST http://localhost:5000/filters/apply \
  -F "image=@photo.jpg" \
  -F "filter_name=boomerang" \
  -o boomerang_output.jpg
```

**Efecto**: Duplica la imagen y crea un espejo horizontal.

---

### 7. CR7 Mask (`cr7`)

**Descripci√≥n**: Overlay de m√°scara tem√°tica CR7.

**Par√°metros**: Ninguno

**Caracter√≠sticas**:
- M√°scara PNG tem√°tica
- Alpha blending
- Posicionamiento centrado

---

## üõ†Ô∏è Desarrollo Local

### Ejecuci√≥n del Servidor

```bash
# Activar entorno virtual
source venv/bin/activate  # Linux/Mac
.\venv\Scripts\activate   # Windows

# M√©todo 1: Uvicorn directo
uvicorn app:app --host 0.0.0.0 --port 5000 --reload

# M√©todo 2: Python
python app.py

# M√©todo 3: Con workers m√∫ltiples (producci√≥n)
uvicorn app:app --host 0.0.0.0 --port 5000 --workers 4
```

### Testing

```bash
# Test health endpoint
curl http://localhost:5000/health

# Test con imagen
curl -X POST http://localhost:5000/filters/apply \
  -F "image=@test_image.jpg" \
  -F "filter_name=gaussian" \
  -o output.jpg

# Ver imagen resultante
open output.jpg  # Mac
xdg-open output.jpg  # Linux
start output.jpg  # Windows
```

### Python Testing Script

```python
# test_filters.py
import requests

def test_gaussian_filter():
    url = "http://localhost:5000/filters/apply"
    
    with open("test_image.jpg", "rb") as img:
        files = {"image": img}
        data = {"filter_name": "gaussian", "mask_size": 5}
        
        response = requests.post(url, files=files, data=data)
        
        if response.status_code == 200:
            with open("output_gaussian.jpg", "wb") as out:
                out.write(response.content)
            print("‚úÖ Filtro aplicado correctamente")
        else:
            print(f"‚ùå Error: {response.json()}")

if __name__ == "__main__":
    test_gaussian_filter()
```

---

## üê≥ Docker

### Dockerfile

```dockerfile
FROM nvidia/cuda:12.2.0-runtime-ubuntu22.04

# Install Python and dependencies
RUN apt-get update && apt-get install -y \
    python3.10 \
    python3-pip \
    libgl1-mesa-glx \
    libglib2.0-0 \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copy requirements and install
COPY requirements.txt .
RUN pip3 install --no-cache-dir -r requirements.txt

# Copy application
COPY . .

# Expose port
EXPOSE 5000

# Health check
HEALTHCHECK --interval=30s --timeout=10s --retries=3 \
  CMD curl -f http://localhost:5000/health || exit 1

# Run server
CMD ["uvicorn", "app:app", "--host", "0.0.0.0", "--port", "5000"]
```

### Build & Run

```bash
# Build image
docker build -t upsglam-cuda-backend:latest .

# Run with GPU support
docker run -d \
  --name cuda-backend \
  -p 5000:5000 \
  --gpus all \
  -e CUDA_VISIBLE_DEVICES=0 \
  upsglam-cuda-backend:latest

# Logs
docker logs -f cuda-backend

# GPU monitoring
nvidia-smi -l 1
```

### Docker Compose

```yaml
cuda-backend:
  build:
    context: ./cuda-lab-back
    dockerfile: Dockerfile
  container_name: upsglam-cuda-backend
  ports:
    - "5000:5000"
  environment:
    - CUDA_VISIBLE_DEVICES=0
  deploy:
    resources:
      reservations:
        devices:
          - driver: nvidia
            count: all
            capabilities: [gpu]
  networks:
    - upsglam-network
```

---

## üìä Rendimiento

### Benchmarks

| Filtro | Resoluci√≥n | CPU Time | GPU Time | Speedup |
|--------|------------|----------|----------|---------|
| Gaussian 5x5 | 1920x1080 | 450ms | 12ms | 37.5x |
| Box Blur 5x5 | 1920x1080 | 380ms | 9ms | 42.2x |
| Prewitt | 1920x1080 | 520ms | 15ms | 34.7x |
| Laplacian | 1920x1080 | 490ms | 13ms | 37.7x |

### Optimizaciones CUDA

```python
# Block dimensions optimizadas
BLOCK_SIZE = (16, 16)  # 256 threads per block

# Grid dimensions calculadas autom√°ticamente
grid_x = (width + BLOCK_SIZE[0] - 1) // BLOCK_SIZE[0]
grid_y = (height + BLOCK_SIZE[1] - 1) // BLOCK_SIZE[1]
```

---

## üêõ Troubleshooting

### Error: CUDA not available

```bash
# Verificar NVIDIA driver
nvidia-smi

# Verificar CUDA
python -c "import pycuda.driver as cuda; cuda.init(); print(cuda.Device.count())"

# Reinstalar PyCUDA
pip uninstall pycuda
pip install pycuda
```

### Error: Out of GPU memory

```python
# Reducir resoluci√≥n de imagen antes de procesar
# O procesar por chunks (progressive_convolution.py)
```

### Error: Import errors

```bash
# Reinstalar dependencias
pip install -r requirements.txt --force-reinstall
```

---

## üìö Referencias

- [PyCUDA Documentation](https://documen.tician.de/pycuda/)
- [CUDA Programming Guide](https://docs.nvidia.com/cuda/)
- [FastAPI Documentation](https://fastapi.tiangolo.com/)
- [OpenCV Documentation](https://docs.opencv.org/)

---

## üìù Changelog

### Version 1.0.0
- ‚úÖ FastAPI REST API
- ‚úÖ PyCUDA GPU acceleration
- ‚úÖ 7 filtros implementados
- ‚úÖ Endpoints modernos y legacy
- ‚úÖ Docker con GPU support
- ‚úÖ Health checks y monitoring

---

## üë• Autor

UPSGlam Development Team - Universidad Polit√©cnica Salesiana
